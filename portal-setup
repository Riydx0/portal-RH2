#!/bin/bash

# IT Service Portal - Cloudron Style Installation
# Ø§Ø³ØªØ®Ø¯Ø§Ù…:
#   wget https://raw.githubusercontent.com/Riydx0/portal-RH2/main/portal-setup
#   chmod +x portal-setup
#   ./portal-setup

set -e

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  ğŸš€ IT Service Portal - Setup              â•‘"
echo "â•‘                                            â•‘"
echo "â•‘  Similar to: Cloudron, Umbrel, Yunohost   â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Check Node.js
if ! command -v node &> /dev/null; then
    echo "âŒ Node.js is required but not installed"
    echo ""
    echo "Install Node.js 20+ first:"
    echo "  curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -"
    echo "  sudo apt install -y nodejs"
    echo ""
    exit 1
fi

echo "âœ… Node.js $(node -v)"
echo ""

# Create installation directory
INSTALL_PATH="${HOME}/portal"

if [ -d "$INSTALL_PATH" ]; then
    echo "âš ï¸  Directory exists: $INSTALL_PATH"
    read -p "Continue and overwrite? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
    rm -rf "$INSTALL_PATH"
fi

mkdir -p "$INSTALL_PATH"
cd "$INSTALL_PATH"

echo "ğŸ“¥ Downloading portal (this may take a minute)..."
echo ""

# Download as ZIP
if ! wget -q --show-progress https://github.com/Riydx0/portal-RH2/archive/refs/heads/main.zip; then
    echo "âŒ Failed to download. Check internet connection."
    exit 1
fi

echo ""
echo "ğŸ“‚ Extracting files..."
unzip -q main.zip
rm main.zip

# Move extracted files
if [ -d "portal-RH2-main" ]; then
    mv portal-RH2-main/* .
    rmdir portal-RH2-main
fi

echo ""
echo "ğŸ“¦ Installing dependencies (this may take several minutes)..."
npm install --production

echo ""
echo "ğŸ”¨ Building project..."
npm run build

echo ""
echo "ğŸ“Š Setting up database..."
npm run db:push

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘          âœ… SETUP COMPLETE!               â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“ Installation: $INSTALL_PATH"
echo ""
echo "â–¶ï¸  START THE APPLICATION:"
echo "   cd $INSTALL_PATH"
echo "   npm run dev"
echo ""
echo "ğŸŒ THEN OPEN IN BROWSER:"
echo "   http://localhost:5000"
echo ""
echo "ğŸ‘¤ LOGIN WITH:"
echo "   Email:    admin@portal"
echo "   Password: admin"
echo ""
echo "âš ï¸  IMPORTANT:"
echo "   â€¢ Change admin password immediately"
echo "   â€¢ Configure email settings in Admin Panel"
echo "   â€¢ For production: Set NODE_ENV=production"
echo ""
echo "ğŸ“š Documentation:"
echo "   https://github.com/Riydx0/portal-RH2"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
