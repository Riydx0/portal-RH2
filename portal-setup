#!/bin/bash

# IT Service Portal - One Command Setup
# Usage:
#   wget https://raw.githubusercontent.com/Riydx0/portal-RH2/main/portal-setup
#   chmod +x portal-setup
#   sudo ./portal-setup

set -e

echo ""
echo "╔════════════════════════════════════════════╗"
echo "║  🚀 IT Service Portal - Complete Setup     ║"
echo "╚════════════════════════════════════════════╝"
echo ""

# Check root
if [ "$EUID" -ne 0 ]; then
    echo "⚠️  Run with sudo: sudo ./portal-setup"
    exit 1
fi

ACTUAL_USER="${SUDO_USER:-$USER}"
INSTALL_PATH="/home/$ACTUAL_USER/portal"
if [ "$ACTUAL_USER" = "root" ]; then
    INSTALL_PATH="/root/portal"
fi

echo "📍 Installing to: $INSTALL_PATH"
echo ""

# Step 1: Node.js
echo "🔍 Checking Node.js..."
if ! command -v node &> /dev/null; then
    echo "📥 Installing Node.js 20..."
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    apt-get install -y nodejs
fi
echo "✅ Node.js $(node -v)"

# Step 2: PostgreSQL
echo "🔍 Checking PostgreSQL..."
apt-get update -qq
apt-get install -y postgresql postgresql-contrib git
systemctl enable postgresql
systemctl start postgresql
echo "✅ PostgreSQL installed"

# Step 3: Create Database
echo "📊 Creating database..."
sudo -u postgres psql -c "DROP DATABASE IF EXISTS portal_db;" 2>/dev/null || true
sudo -u postgres psql -c "DROP USER IF EXISTS portal_user;" 2>/dev/null || true
sudo -u postgres psql -c "CREATE USER portal_user WITH PASSWORD 'portal123';"
sudo -u postgres psql -c "CREATE DATABASE portal_db OWNER portal_user;"
echo "✅ Database created"

# Step 4: Clone
echo "📥 Downloading portal..."
rm -rf "$INSTALL_PATH"
git clone https://github.com/Riydx0/portal-RH2.git "$INSTALL_PATH"
echo "✅ Downloaded"

# Step 5: Create .env
echo "🔧 Creating config..."
cat > "$INSTALL_PATH/.env" << 'EOF'
DATABASE_URL=postgresql://portal_user:portal123@localhost:5432/portal_db
SESSION_SECRET=supersecretkey123456789abcdef
NODE_ENV=production
EOF
echo "✅ Config created"

# Step 6: Install
echo "📦 Installing dependencies..."
cd "$INSTALL_PATH"
npm install --production > /dev/null 2>&1
echo "✅ Dependencies installed"

# Step 7: Build
echo "🔨 Building..."
npm run build > /dev/null 2>&1
echo "✅ Built"

# Step 8: Database
echo "📊 Setting up database..."
npm run db:push > /dev/null 2>&1
echo "✅ Database ready"

# Step 9: Firewall
echo "🔥 Opening port 5000..."
ufw allow 5000 2>/dev/null || true

echo ""
echo "╔════════════════════════════════════════════╗"
echo "║          ✅ SETUP COMPLETE!               ║"
echo "╚════════════════════════════════════════════╝"
echo ""
echo "▶️  START:"
echo "   cd $INSTALL_PATH && npm run dev"
echo ""
echo "🌐 OPEN:"
echo "   http://YOUR_SERVER_IP:5000"
echo ""
echo "👤 LOGIN:"
echo "   Email: admin@portal"
echo "   Password: admin"
echo ""
echo "════════════════════════════════════════════"
