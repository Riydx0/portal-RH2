#!/bin/bash

# IT Service Portal - Cloudron Style Installation
# Using git clone for reliable downloads
#
# Usage:
#   wget https://raw.githubusercontent.com/Riydx0/portal-RH2/main/portal-setup
#   chmod +x portal-setup
#   ./portal-setup [github-token-optional]

set -e

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  ğŸš€ IT Service Portal - Setup              â•‘"
echo "â•‘                                            â•‘"
echo "â•‘  One-Command Cloudron-Style Installation  â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Check Node.js
if ! command -v node &> /dev/null; then
    echo "âŒ Node.js is required but not installed"
    echo ""
    echo "Install Node.js 20+ first:"
    echo "  curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -"
    echo "  sudo apt install -y nodejs"
    echo ""
    exit 1
fi

echo "âœ… Node.js $(node -v)"
echo "âœ… npm $(npm -v)"
echo ""

# Check git
if ! command -v git &> /dev/null; then
    echo "âŒ git is required but not installed"
    echo "Install: sudo apt install -y git"
    exit 1
fi

echo "âœ… git $(git --version | cut -d' ' -f3)"
echo ""

# Create installation directory
INSTALL_PATH="${HOME}/portal"

if [ -d "$INSTALL_PATH" ]; then
    echo "âš ï¸  Directory exists: $INSTALL_PATH"
    read -p "Continue and overwrite? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
    rm -rf "$INSTALL_PATH"
fi

echo "ğŸ“¥ Cloning repository from GitHub..."
echo ""

# Clone repository
GITHUB_TOKEN="${1:-}"

if [ -n "$GITHUB_TOKEN" ]; then
    # Private repo with token
    git clone https://${GITHUB_TOKEN}@github.com/Riydx0/portal-RH2.git "$INSTALL_PATH" 2>&1 | grep -v "^remote:" | head -20
else
    # Public repo or public read access
    git clone https://github.com/Riydx0/portal-RH2.git "$INSTALL_PATH" 2>&1 | grep -v "^remote:" | head -20
fi

if [ ! -d "$INSTALL_PATH" ]; then
    echo "âŒ Clone failed"
    exit 1
fi

cd "$INSTALL_PATH"

echo ""
echo "âœ… Repository cloned"
echo ""

# Verify package.json
if [ ! -f "package.json" ]; then
    echo "âŒ package.json not found"
    exit 1
fi

echo "ğŸ“¦ Installing dependencies..."
echo "   (This may take 3-5 minutes...)"
echo ""
npm install --production > /tmp/npm_install.log 2>&1 || {
    echo "âŒ npm install failed"
    tail -20 /tmp/npm_install.log
    exit 1
}
echo "âœ… Dependencies installed"
echo ""

echo "ğŸ”¨ Building project..."
npm run build > /tmp/npm_build.log 2>&1 || {
    echo "âŒ Build failed"
    tail -20 /tmp/npm_build.log
    exit 1
}
echo "âœ… Build complete"
echo ""

echo "ğŸ“Š Setting up database..."
npm run db:push > /tmp/npm_db.log 2>&1 || {
    echo "âŒ Database setup failed"
    tail -20 /tmp/npm_db.log
    exit 1
}
echo "âœ… Database ready"
echo ""

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘          âœ… SETUP COMPLETE!               â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“ Installation: $INSTALL_PATH"
echo ""
echo "â–¶ï¸  START THE APPLICATION:"
echo "   cd $INSTALL_PATH"
echo "   npm run dev"
echo ""
echo "ğŸŒ THEN OPEN IN BROWSER:"
echo "   http://localhost:5000"
echo ""
echo "ğŸ‘¤ LOGIN WITH:"
echo "   Email:    admin@portal"
echo "   Password: admin"
echo ""
echo "âš ï¸  IMPORTANT:"
echo "   â€¢ Change admin password immediately"
echo "   â€¢ Configure email settings in Admin Panel"
echo "   â€¢ For production: Set NODE_ENV=production"
echo ""
echo "ğŸ“š GitHub: https://github.com/Riydx0/portal-RH2"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
