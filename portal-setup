#!/bin/bash

# IT Service Portal - Complete Auto-Setup
# Cloudron-Style: One command does everything!
#
# Usage:
#   wget https://raw.githubusercontent.com/Riydx0/portal-RH2/main/portal-setup
#   chmod +x portal-setup
#   sudo ./portal-setup

set -e

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  ðŸš€ IT Service Portal - Complete Setup     â•‘"
echo "â•‘                                            â•‘"
echo "â•‘  Cloudron-Style Auto Installation         â•‘"
echo "â•‘  Node.js + PostgreSQL + App               â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    echo "âš ï¸  Please run with sudo:"
    echo "   sudo ./portal-setup"
    exit 1
fi

# Get actual user (not root)
ACTUAL_USER="${SUDO_USER:-$USER}"
ACTUAL_HOME=$(eval echo ~$ACTUAL_USER)
INSTALL_PATH="${ACTUAL_HOME}/portal"

echo "ðŸ“ Installing to: $INSTALL_PATH"
echo "ðŸ‘¤ User: $ACTUAL_USER"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 1: Install Node.js if needed
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "ðŸ” Checking Node.js..."
if ! command -v node &> /dev/null; then
    echo "ðŸ“¥ Installing Node.js 20..."
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    apt-get install -y nodejs
fi
echo "âœ… Node.js $(node -v)"
echo "âœ… npm $(npm -v)"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 2: Install PostgreSQL if needed
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "ðŸ” Checking PostgreSQL..."
if ! command -v psql &> /dev/null; then
    echo "ðŸ“¥ Installing PostgreSQL..."
    apt-get update
    apt-get install -y postgresql postgresql-contrib
fi

# Start PostgreSQL
systemctl enable postgresql
systemctl start postgresql
echo "âœ… PostgreSQL installed"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 3: Create Database
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "ðŸ“Š Setting up database..."

DB_NAME="portal_db"
DB_USER="portal_user"
DB_PASS=$(openssl rand -base64 16 | tr -dc 'a-zA-Z0-9' | head -c 16)

# Create user and database
sudo -u postgres psql -c "DROP DATABASE IF EXISTS $DB_NAME;" 2>/dev/null || true
sudo -u postgres psql -c "DROP USER IF EXISTS $DB_USER;" 2>/dev/null || true
sudo -u postgres psql -c "CREATE USER $DB_USER WITH PASSWORD '$DB_PASS';"
sudo -u postgres psql -c "CREATE DATABASE $DB_NAME OWNER $DB_USER;"
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER;"

DATABASE_URL="postgresql://$DB_USER:$DB_PASS@localhost:5432/$DB_NAME"
echo "âœ… Database created"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 4: Install Git if needed
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "ðŸ” Checking Git..."
if ! command -v git &> /dev/null; then
    echo "ðŸ“¥ Installing Git..."
    apt-get install -y git
fi
echo "âœ… Git $(git --version | cut -d' ' -f3)"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 5: Clone Repository
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "ðŸ“¥ Downloading IT Service Portal..."

# Remove old installation
rm -rf "$INSTALL_PATH"
mkdir -p "$INSTALL_PATH"

# Clone
git clone https://github.com/Riydx0/portal-RH2.git "$INSTALL_PATH"
chown -R $ACTUAL_USER:$ACTUAL_USER "$INSTALL_PATH"

echo "âœ… Repository cloned"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 6: Create .env file
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "ðŸ”§ Creating configuration..."

SESSION_SECRET=$(openssl rand -base64 32)

cat > "$INSTALL_PATH/.env" << EOF
# Database
DATABASE_URL=$DATABASE_URL
PGHOST=localhost
PGPORT=5432
PGUSER=$DB_USER
PGPASSWORD=$DB_PASS
PGDATABASE=$DB_NAME

# Session & Security
SESSION_SECRET=$SESSION_SECRET
NODE_ENV=production

# Application
VITE_APP_NAME=IT Service Portal
VITE_APP_URL=http://localhost:5000
EOF

chown $ACTUAL_USER:$ACTUAL_USER "$INSTALL_PATH/.env"
echo "âœ… Configuration created"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 7: Install Dependencies
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "ðŸ“¦ Installing dependencies (this may take 3-5 minutes)..."
cd "$INSTALL_PATH"
sudo -u $ACTUAL_USER npm install > /tmp/npm_install.log 2>&1 || {
    echo "âŒ npm install failed"
    tail -20 /tmp/npm_install.log
    exit 1
}
echo "âœ… Dependencies installed"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 8: Build
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "ðŸ”¨ Building project..."
sudo -u $ACTUAL_USER npm run build > /tmp/npm_build.log 2>&1 || {
    echo "âŒ Build failed"
    tail -20 /tmp/npm_build.log
    exit 1
}
echo "âœ… Build complete"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 9: Database Migration
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "ðŸ“Š Migrating database..."
cd "$INSTALL_PATH"
sudo -u $ACTUAL_USER bash -c "export DATABASE_URL='$DATABASE_URL' && npm run db:push" > /tmp/npm_db.log 2>&1 || {
    echo "âŒ Database migration failed"
    tail -20 /tmp/npm_db.log
    exit 1
}
echo "âœ… Database ready"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 10: Create Systemd Service
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "âš™ï¸  Creating system service..."

cat > /etc/systemd/system/portal.service << EOF
[Unit]
Description=IT Service Portal
After=network.target postgresql.service

[Service]
Type=simple
User=$ACTUAL_USER
WorkingDirectory=$INSTALL_PATH
ExecStart=/usr/bin/npm run dev
Restart=on-failure
RestartSec=10
Environment=NODE_ENV=production

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable portal
echo "âœ… System service created"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DONE!
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘          âœ… SETUP COMPLETE!               â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ðŸ“ Installation: $INSTALL_PATH"
echo ""
echo "â–¶ï¸  START THE APPLICATION:"
echo "   sudo systemctl start portal"
echo ""
echo "   Or manually:"
echo "   cd $INSTALL_PATH && npm run dev"
echo ""
echo "ðŸŒ OPEN IN BROWSER:"
echo "   http://YOUR_SERVER_IP:5000"
echo ""
echo "ðŸ‘¤ LOGIN WITH:"
echo "   Email:    admin@portal"
echo "   Password: admin"
echo ""
echo "ðŸ“Š DATABASE INFO:"
echo "   User: $DB_USER"
echo "   Pass: $DB_PASS"
echo "   Name: $DB_NAME"
echo ""
echo "âš ï¸  IMPORTANT:"
echo "   â€¢ Change admin password immediately!"
echo "   â€¢ Save database credentials above!"
echo ""
echo "ðŸ“š Commands:"
echo "   Start:   sudo systemctl start portal"
echo "   Stop:    sudo systemctl stop portal"
echo "   Status:  sudo systemctl status portal"
echo "   Logs:    journalctl -u portal -f"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
