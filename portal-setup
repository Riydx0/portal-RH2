#!/bin/bash

# IT Service Portal - Cloudron Style Installation
# One-command setup for Linux servers
#
# Usage:
#   wget https://raw.githubusercontent.com/Riydx0/portal-RH2/main/portal-setup
#   chmod +x portal-setup
#   ./portal-setup

set -e

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  ğŸš€ IT Service Portal - Setup              â•‘"
echo "â•‘                                            â•‘"
echo "â•‘  One-Command Cloudron-Style Installation  â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Check Node.js
if ! command -v node &> /dev/null; then
    echo "âŒ Node.js is required but not installed"
    echo ""
    echo "Install Node.js 20+ first:"
    echo "  curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -"
    echo "  sudo apt install -y nodejs"
    echo ""
    exit 1
fi

echo "âœ… Node.js $(node -v)"
echo ""

# Check npm
if ! command -v npm &> /dev/null; then
    echo "âŒ npm not found"
    exit 1
fi

echo "âœ… npm $(npm -v)"
echo ""

# Create installation directory
INSTALL_PATH="${HOME}/portal"

if [ -d "$INSTALL_PATH" ]; then
    echo "âš ï¸  Directory exists: $INSTALL_PATH"
    read -p "Continue and overwrite? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
    rm -rf "$INSTALL_PATH"
fi

mkdir -p "$INSTALL_PATH"
cd "$INSTALL_PATH"

echo "ğŸ“¥ Downloading portal from GitHub..."
echo ""

# Download - try curl first, then wget
DOWNLOAD_OK=false

if command -v curl &> /dev/null; then
    if curl -L -o main.zip https://github.com/Riydx0/portal-RH2/archive/refs/heads/main.zip 2>/dev/null; then
        DOWNLOAD_OK=true
    fi
fi

if [ "$DOWNLOAD_OK" = false ] && command -v wget &> /dev/null; then
    if wget -q --show-progress https://github.com/Riydx0/portal-RH2/archive/refs/heads/main.zip -O main.zip; then
        DOWNLOAD_OK=true
    fi
fi

if [ "$DOWNLOAD_OK" = false ]; then
    echo "âŒ Failed to download. Check internet connection."
    echo ""
    echo "Try manual download:"
    echo "  cd $INSTALL_PATH"
    echo "  wget https://github.com/Riydx0/portal-RH2/archive/refs/heads/main.zip"
    echo "  unzip main.zip"
    echo "  mv portal-RH2-main/* ."
    echo "  rm -rf portal-RH2-main main.zip"
    exit 1
fi

echo ""
echo "âœ… Download complete"
echo ""

# Verify ZIP
if ! unzip -t main.zip > /dev/null 2>&1; then
    echo "âŒ ZIP file is corrupted"
    rm -f main.zip
    exit 1
fi

echo "ğŸ“‚ Extracting files..."
unzip -q main.zip

# Move extracted files
if [ -d "portal-RH2-main" ]; then
    mv portal-RH2-main/* .
    rmdir portal-RH2-main
fi

rm -f main.zip

# Verify we have package.json
if [ ! -f "package.json" ]; then
    echo "âŒ Installation failed - package.json not found"
    exit 1
fi

echo "âœ… Files extracted"
echo ""

echo "ğŸ“¦ Installing dependencies..."
echo "   (This may take 3-5 minutes...)"
echo ""
npm install --production 2>&1 | tail -20

echo ""
echo "âœ… Dependencies installed"
echo ""

echo "ğŸ”¨ Building project..."
npm run build 2>&1 | tail -10

echo ""
echo "âœ… Build complete"
echo ""

echo "ğŸ“Š Setting up database..."
npm run db:push 2>&1 | tail -10

echo ""
echo "âœ… Database ready"
echo ""

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘          âœ… SETUP COMPLETE!               â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“ Installation: $INSTALL_PATH"
echo ""
echo "â–¶ï¸  START THE APPLICATION:"
echo "   cd $INSTALL_PATH"
echo "   npm run dev"
echo ""
echo "ğŸŒ THEN OPEN IN BROWSER:"
echo "   http://localhost:5000"
echo ""
echo "ğŸ‘¤ LOGIN WITH:"
echo "   Email:    admin@portal"
echo "   Password: admin"
echo ""
echo "âš ï¸  IMPORTANT:"
echo "   â€¢ Change admin password immediately"
echo "   â€¢ Configure email settings in Admin Panel"
echo "   â€¢ For production: Set NODE_ENV=production"
echo ""
echo "ğŸ“š GitHub: https://github.com/Riydx0/portal-RH2"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
